"use strict";(globalThis.webpackChunkdocs=globalThis.webpackChunkdocs||[]).push([[779],{5756(e,n,s){s.d(n,{R:()=>a,x:()=>o});var r=s(9471);const i={},t=r.createContext(i);function a(e){const n=r.useContext(t);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:a(e.components),r.createElement(t.Provider,{value:n},e.children)}},6602(e,n,s){s.r(n),s.d(n,{assets:()=>d,contentTitle:()=>o,default:()=>h,frontMatter:()=>a,metadata:()=>r,toc:()=>c});const r=JSON.parse('{"id":"linux-advanced/Docker/postgres-upgrades","title":"Upgrading Postgres SQL in a Docker Environment","description":"At the time of writing, this will upgrade postgres 16 to 17. This guide will walk through:","source":"@site/docs/linux-advanced/Docker/postgres-upgrades.md","sourceDirName":"linux-advanced/Docker","slug":"/linux-advanced/Docker/postgres-upgrades","permalink":"/docs/linux-advanced/Docker/postgres-upgrades","draft":false,"unlisted":false,"editUrl":"https://github.com/echo-core/docs-site/tree/main/site/docs/linux-advanced/Docker/postgres-upgrades.md","tags":[],"version":"current","sidebarPosition":1,"frontMatter":{"sidebar_position":1},"sidebar":"tutorialSidebar","previous":{"title":"Debian Full Disk Encryption Installation","permalink":"/docs/linux-advanced/Debian/debian-install-enc"}}');var i=s(2615),t=s(5756);const a={sidebar_position:1},o="Upgrading Postgres SQL in a Docker Environment",d={},c=[{value:"Backup databases",id:"backup-databases",level:2},{value:"Upgrade <code>postgres</code> to <code>17</code>",id:"upgrade-postgres-to-17",level:2},{value:"Import databases",id:"import-databases",level:2},{value:"Verify databases",id:"verify-databases",level:2},{value:"References",id:"references",level:2}];function l(e){const n={a:"a",admonition:"admonition",code:"code",em:"em",h1:"h1",h2:"h2",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,t.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"upgrading-postgres-sql-in-a-docker-environment",children:"Upgrading Postgres SQL in a Docker Environment"})}),"\n",(0,i.jsxs)(n.p,{children:["At the time of writing, this will upgrade ",(0,i.jsx)(n.code,{children:"postgres"})," ",(0,i.jsx)(n.code,{children:"16"})," to ",(0,i.jsx)(n.code,{children:"17"}),". This guide will walk through:"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Creating a backup."}),"\n",(0,i.jsxs)(n.li,{children:["Installing the new version of ",(0,i.jsx)(n.code,{children:"postgres"}),"."]}),"\n",(0,i.jsx)(n.li,{children:"Importing the backup."}),"\n",(0,i.jsx)(n.li,{children:"Verifying the upgrade was a success."}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.em,{children:"This guide assumes you already have an existing image configured and working."})}),"\n",(0,i.jsx)(n.admonition,{type:"warning",children:(0,i.jsx)(n.p,{children:"Make sure to keep backups, because you never know..."})}),"\n",(0,i.jsx)(n.h2,{id:"backup-databases",children:"Backup databases"}),"\n",(0,i.jsx)(n.admonition,{type:"danger",children:(0,i.jsxs)(n.p,{children:["Take care to double check before editing your ",(0,i.jsx)(n.code,{children:"yaml"})," files and verify the commands are correct for your environment before executing these. Needless to say your environment could suffer greatly if the process isn't handled with care."]})}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsx)(n.li,{children:"Create a directory to mount to dump the backups to."}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"mkdir ${DB_PATH}/pg-bu\n"})}),"\n",(0,i.jsxs)(n.ol,{start:"2",children:["\n",(0,i.jsx)(n.li,{children:"Modify your existing image and mount the directory."}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"  postgres:\n    image: postgres:16\n    container_name: postgres\n    restart: unless-stopped\n    ports:\n      - 5432:5432\n    volumes:\n      - ${DB_PATH}/pg16:/var/lib/postgresql/data\n      - ${DB_PATH}/pg-bu:/pg-bu\n    healthcheck:\n      test:\n        - CMD-SHELL\n        - pg_isready -d $${POSTGRES_DB} -U $${POSTGRES_USER}\n      start_period: 20s\n      interval: 30s\n      retries: 5\n      timeout: 5s\n    env_file:\n      - .env\n"})}),"\n",(0,i.jsxs)(n.ol,{start:"3",children:["\n",(0,i.jsx)(n.li,{children:"Create the backup."}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsxs)(n.em,{children:["Modify ",(0,i.jsx)(n.code,{children:"$POSTGRES_USER"})," to your ",(0,i.jsx)(n.code,{children:"postgres"})," admin user."]})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"docker exec -it postgres /bin/bash -c 'pg_dumpall -U $POSTGRES_USER > /pg-bu/all-dbs.sql'\n"})}),"\n",(0,i.jsxs)(n.ol,{start:"4",children:["\n",(0,i.jsx)(n.li,{children:"Stop the old container."}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"docker compose down\n"})}),"\n",(0,i.jsxs)(n.h2,{id:"upgrade-postgres-to-17",children:["Upgrade ",(0,i.jsx)(n.code,{children:"postgres"})," to ",(0,i.jsx)(n.code,{children:"17"})]}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsx)(n.li,{children:"Create new server directory"}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"mkdir ${DB_PATH}/pg17\n"})}),"\n",(0,i.jsxs)(n.ol,{start:"2",children:["\n",(0,i.jsx)(n.li,{children:"Modify your docker compose file for the new version."}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsxs)(n.em,{children:["Note: the tag has changed to ",(0,i.jsx)(n.code,{children:"17"})," and the volume have changed to ",(0,i.jsx)(n.code,{children:"pg17"}),"."]})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"  postgres:\n    image: postgres:17\n    container_name: postgres\n    restart: unless-stopped\n    ports:\n      - 5432:5432\n    volumes:\n      - ${DB_PATH}/pg17:/var/lib/postgresql/data\n      - ${DB_PATH}/pg-bu:/pg-bu\n    healthcheck:\n      test:\n        - CMD-SHELL\n        - pg_isready -d $${POSTGRES_DB} -U $${POSTGRES_USER}\n      start_period: 20s\n      interval: 30s\n      retries: 5\n      timeout: 5s\n    env_file:\n      - .env\n"})}),"\n",(0,i.jsxs)(n.ol,{start:"3",children:["\n",(0,i.jsx)(n.li,{children:"Start the new container."}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"docker compose pull && docker compose up -d\n"})}),"\n",(0,i.jsx)(n.h2,{id:"import-databases",children:"Import databases"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsx)(n.li,{children:"Verify database backup is accessible."}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"docker exec -it postgres /bin/ls /pg-bu\n"})}),"\n",(0,i.jsxs)(n.ol,{start:"2",children:["\n",(0,i.jsx)(n.li,{children:"Import backups."}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsxs)(n.em,{children:["Modify ",(0,i.jsx)(n.code,{children:"$POSTGRES_DB"})," to your ",(0,i.jsx)(n.code,{children:"postgres"})," database and set ",(0,i.jsx)(n.code,{children:"$POSTGRES_USER"})," to your ",(0,i.jsx)(n.code,{children:"postgres"})," admin user."]})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"docker exec -it postgres /bin/bash -c 'psql -d $POSTGRES_DB -U $POSTGRES_USER < /pg-bu/all-dbs.sql'\n"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.em,{children:"At this point your database server should be working and accepting connections to your existing databases."})}),"\n",(0,i.jsx)(n.h2,{id:"verify-databases",children:"Verify databases"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.em,{children:"Modify $POSTGRES_USER to your postgres admin user."})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"docker exec -it postgres /bin/bash -c 'psql -U $POSTGRES_USER -l'\n"})}),"\n",(0,i.jsx)(n.p,{children:"You should get output similar to below verifying the databases exist:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"                                                     List of databases\n    Name     |    Owner    | Encoding | Locale Provider |  Collate   |   Ctype    | Locale | ICU Rules | Access privileges\n-------------+-------------+----------+-----------------+------------+------------+--------+-----------+-------------------\n authentik   | authentik   | UTF8     | libc            | en_US.utf8 | en_US.utf8 |        |           |\n immich      | immich      | UTF8     | libc            | en_US.utf8 | en_US.utf8 |        |           |\n joplin      | joplin      | UTF8     | libc            | en_US.utf8 | en_US.utf8 |        |           |\n mealie      | mealie      | UTF8     | libc            | en_US.utf8 | en_US.utf8 |        |           |\n npm         | npm         | UTF8     | libc            | en_US.utf8 | en_US.utf8 |        |           |\n postgres    | admin       | UTF8     | libc            | en_US.utf8 | en_US.utf8 |        |           |\n semaphore   | semaphore   | UTF8     | libc            | en_US.utf8 | en_US.utf8 |        |           |\n template0   | admin       | UTF8     | libc            | en_US.utf8 | en_US.utf8 |        |           | =c/admin         +\n             |             |          |                 |            |            |        |           | admin=CTc/admin\n template1   | admin       | UTF8     | libc            | en_US.utf8 | en_US.utf8 |        |           | =c/admin         +\n             |             |          |                 |            |            |        |           | admin=CTc/admin\n vaultwarden | vaultwarden | UTF8     | libc            | en_US.utf8 | en_US.utf8 |        |           |\n(10 rows)\n"})}),"\n",(0,i.jsx)(n.h2,{id:"references",children:"References"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"https://blog.oxyconit.com/how-to-update-postgres-16-to-17-in-docker",children:"Upgrade PostgresSQL from 16 to 17 in Docker"})}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(l,{...e})}):l(e)}}}]);