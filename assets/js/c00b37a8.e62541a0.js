"use strict";(globalThis.webpackChunkdocs=globalThis.webpackChunkdocs||[]).push([[161],{2549(e,n,s){s.r(n),s.d(n,{assets:()=>o,contentTitle:()=>i,default:()=>h,frontMatter:()=>l,metadata:()=>r,toc:()=>c});const r=JSON.parse('{"id":"linux-advanced/Debian/debian-install-enc","title":"Debian Full Disk Encryption Installation","description":"This was done with a lot of research, trial-and-error, and finally led to success. Eventually, I would like to do a full debootstrap installation to avoid some of the annoyances in this article. I would do another article for that setup.","source":"@site/docs/linux-advanced/Debian/debian-install-enc.md","sourceDirName":"linux-advanced/Debian","slug":"/linux-advanced/Debian/debian-install-enc","permalink":"/docs/linux-advanced/Debian/debian-install-enc","draft":false,"unlisted":false,"editUrl":"https://github.com/echo-core/docs/tree/main/site/docs/linux-advanced/Debian/debian-install-enc.md","tags":[],"version":"current","sidebarPosition":1,"frontMatter":{"sidebar_position":1},"sidebar":"tutorialSidebar","previous":{"title":"Linux Howtos - Advanced","permalink":"/docs/category/linux-howtos---advanced"},"next":{"title":"Upgrading Postgres SQL in a Docker Environment","permalink":"/docs/linux-advanced/Docker/postgres-upgrades"}}');var t=s(4848),a=s(8453);const l={sidebar_position:1},i="Debian Full Disk Encryption Installation",o={},c=[{value:"Install Debian",id:"install-debian",level:2},{value:"Create key to keep from being asked for two passwords",id:"create-key-to-keep-from-being-asked-for-two-passwords",level:2},{value:"Configure snapper and grub-btrfs",id:"configure-snapper-and-grub-btrfs",level:2},{value:"More useful snapshot descriptions",id:"more-useful-snapshot-descriptions",level:2},{value:"Install snapper-rollback for easy snapper rollbacks",id:"install-snapper-rollback-for-easy-snapper-rollbacks",level:2},{value:"Notes",id:"notes",level:2},{value:"References",id:"references",level:2}];function d(e){const n={a:"a",admonition:"admonition",code:"code",em:"em",h1:"h1",h2:"h2",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,a.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.header,{children:(0,t.jsx)(n.h1,{id:"debian-full-disk-encryption-installation",children:"Debian Full Disk Encryption Installation"})}),"\n",(0,t.jsxs)(n.p,{children:["This was done with a lot of research, trial-and-error, and finally led to success. Eventually, I would like to do a full ",(0,t.jsx)(n.code,{children:"debootstrap"})," installation to avoid some of the annoyances in this article. I would do another article for that setup."]}),"\n",(0,t.jsx)(n.p,{children:"I personally use Debin Sid for this, since the purpose was to roll newer versions of software with the understanding that Sid can break. This provides protection against that breakage and allows for easy rollback if and when that situation arises."}),"\n",(0,t.jsxs)(n.p,{children:["At the time of this writing, Debian Trixie is using GRUB 2.12, which is compatible with luks2, but it only supports the ",(0,t.jsx)(n.code,{children:"pbkdf2"})," algorithm. This installation will do the following:"]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Install Debian using the Expert Install option."}),"\n",(0,t.jsx)(n.li,{children:"Create an EFI partition."}),"\n",(0,t.jsx)(n.li,{children:"Create a luks2 container."}),"\n",(0,t.jsx)(n.li,{children:"Create BTRFS root parititon."}),"\n",(0,t.jsxs)(n.li,{children:["Downgrade pbkdf to ",(0,t.jsx)(n.code,{children:"pbkdf2"}),"."]}),"\n",(0,t.jsx)(n.li,{children:"Install Debian base system."}),"\n",(0,t.jsx)(n.li,{children:"Install GRUB Boot Loader."}),"\n",(0,t.jsx)(n.li,{children:"Install Snapper and associated tools to make managing snapshots easy."}),"\n",(0,t.jsx)(n.li,{children:"Create a base installation snapshot that can be reverted to at anytime."}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:["In addition, the BTRFS subvolumes created ensure that rolling back actually works while balancing ignoring cruft from system snapshots and will not touch a user's ",(0,t.jsx)(n.code,{children:"/home"})," folder. This makes it safe to rollback only the system and not worry about data loss in a user's home folder."]}),"\n",(0,t.jsx)(n.admonition,{type:"warning",children:(0,t.jsx)(n.p,{children:"Make sure to keep backups anyway, because you never know..."})}),"\n",(0,t.jsx)(n.h2,{id:"install-debian",children:"Install Debian"}),"\n",(0,t.jsxs)(n.admonition,{type:"tip",children:[(0,t.jsxs)(n.p,{children:["You can grab the latest stable Debian ",(0,t.jsx)(n.code,{children:"netinst"})," iso from ",(0,t.jsx)(n.strong,{children:(0,t.jsx)(n.em,{children:(0,t.jsx)(n.a,{href:"https://www.debian.org/distrib/netinst",children:"here"})})}),"."]}),(0,t.jsxs)(n.p,{children:["You can grab the latest unstable Debian ",(0,t.jsx)(n.code,{children:"mini"})," iso from ",(0,t.jsx)(n.strong,{children:(0,t.jsx)(n.em,{children:(0,t.jsx)(n.a,{href:"https://d-i.debian.org/daily-images/",children:"here"})})}),"."]})]}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["Boot iso and select the ",(0,t.jsx)(n.code,{children:"Advanced Options... > Expert install"})," option."]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["Run through the install then run the ",(0,t.jsx)(n.code,{children:"Partition disks"})," part of the install in this order."]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Use gpt partition type"}),"\n",(0,t.jsxs)(n.li,{children:["Create Partitions","\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"EFI - 512MB"}),"\n",(0,t.jsxs)(n.li,{children:["Create Encrypted Container","\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Set your password to unlock your luks2 volume. Don't lose this, you'll need it to unlock your computer at every boot moving forward."}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.li,{children:"Create a root BTRFS partition."}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["Go to the console: ",(0,t.jsx)(n.code,{children:"ctrl+alt+f3"}),"."]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["Unmount Debian's current BTRFS ",(0,t.jsx)(n.code,{children:"@rootfs"})," volume from ",(0,t.jsx)(n.code,{children:"/target"}),"."]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"umount /target/boot/efi\numount /target\n"})}),"\n",(0,t.jsxs)(n.ol,{start:"5",children:["\n",(0,t.jsxs)(n.li,{children:["Downgrade pbkdf of luks2 container from ",(0,t.jsx)(n.code,{children:"argon2id"})," to ",(0,t.jsx)(n.code,{children:"pbkdf2"}),"."]}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"cryptsetup luksConvertKey --pbkdf pbkdf2 /dev/vda2\n"})}),"\n",(0,t.jsx)(n.admonition,{type:"tip",children:(0,t.jsxs)(n.p,{children:["This can be upgraded later when GRUB supports ",(0,t.jsx)(n.code,{children:"argon2id"})," and will ",(0,t.jsx)(n.strong,{children:(0,t.jsx)(n.em,{children:"NOT"})})," require wiping your drive to do this. This will make the installation process much easier when that is implemented as we will only need to focus on the BTRFS subvolumes and not worry about this steps for the GRUB Boot Loader."]})}),"\n",(0,t.jsxs)(n.ol,{start:"6",children:["\n",(0,t.jsx)(n.li,{children:"Mount BTRFS parittion."}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"mount /dev/mapper/vda2_crypt /mnt\n"})}),"\n",(0,t.jsxs)(n.ol,{start:"7",children:["\n",(0,t.jsx)(n.li,{children:"Configure BTRFS subvolumes."}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"cd /mnt\n"})}),"\n",(0,t.jsx)(n.p,{children:"Create optimized subvolumes."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"btrfs sub cr @\nbtrfs sub cr @grub\nbtrfs sub cr @home\nbtrfs sub cr @root\nbtrfs sub cr @snapshots\nbtrfs sub cr @srv\nbtrfs sub cr @var_cache\nbtrfs sub cr @var_containers\nbtrfs sub cr @var_libvirt\nbtrfs sub cr @var_log\nbtrfs sub cr @var_tmp\n"})}),"\n",(0,t.jsxs)(n.ol,{start:"8",children:["\n",(0,t.jsx)(n.li,{children:"Mount root BTRFS subvolume."}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"mount -o subvol=@ /dev/mapper/vda2_crypt /target\n"})}),"\n",(0,t.jsxs)(n.ol,{start:"9",children:["\n",(0,t.jsx)(n.li,{children:"Create needed directories, modify as needed."}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"mkdir -p /target/boot/efi\nmkdir -p /target/boot/grub/x86_64-efi\nmkdir /target/etc\nmkdir /target/.snapshots\nmkdir /target/home\nmkdir /target/root\nmkdir /target/srv\nmkdir -p /target/var/cache\nmkdir -p /target/var/lib/containers\nmkdir -p /target/var/lib/libvirt/images\nmkdir -p /target/var/log\nmkdir -p /target/var/tmp\n"})}),"\n",(0,t.jsx)(n.p,{children:"Disable CoW (Copy on Write) for libvirt:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"chattr +C /target/var/lib/libvirt/images\n"})}),"\n",(0,t.jsxs)(n.ol,{start:"10",children:["\n",(0,t.jsxs)(n.li,{children:["Mount BTRFS subvolumes and efi partition to ",(0,t.jsx)(n.code,{children:"/target"})," directories."]}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"mount -o subvol=@grub /dev/mapper/vda2_crypt /target/boot/grub/x86_64-efi\nmount -o subvol=@home /dev/mapper/vda2_crypt /target/home\nmount -o subvol=@snapshots /dev/mapper/vda2_crypt /target/.snapshots\nmount -o subvol=@root /dev/mapper/vda2_crypt /target/root\nmount -o subvol=@srv /dev/mapper/vda2_crypt /target/srv\nmount -o subvol=@var_cache /dev/mapper/vda2_crypt /target/var/cache\nmount -o subvol=@var_containers /dev/mapper/vda2_crypt /target/var/lib/containers\nmount -o subvol=@var_libvirt /dev/mapper/vda2_crypt /target/var/lib/libvirt/images\nmount -o subvol=@var_log /dev/mapper/vda2_crypt /target/var/log\nmount -o subvol=@var_tmp /dev/mapper/vda2_crypt /target/var/tmp\nmount /dev/vda1 /target/boot/efi\n"})}),"\n",(0,t.jsxs)(n.ol,{start:"11",children:["\n",(0,t.jsxs)(n.li,{children:["Copy fstab and crypttab from @rootfs to ",(0,t.jsx)(n.code,{children:"@"}),"."]}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"cp /mnt/@rootfs/etc/* /target/etc/\n"})}),"\n",(0,t.jsxs)(n.ol,{start:"12",children:["\n",(0,t.jsx)(n.li,{children:"Edit fstab with new BTRFS subvolumes."}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"nano /target/etc/fstab\n"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"/dev/mapper/vda2_crypt /               btrfs   defaults,noatime,compress=zstd,subvol=@ 0       0\n/dev/mapper/vda2_crypt /.snapshots               btrfs   defaults,noatime,compress=zstd,commit=120,subvol=@snapshots 0       0\n/dev/mapper/vda2_crypt /boot/grub/x86_64-efi               btrfs   defaults,noatime,compress=zstd,commit=120,subvol=@grub 0       0\n/dev/mapper/vda2_crypt /home               btrfs   defaults,noatime,compress=zstd,commit=120,subvol=@home 0       0\n/dev/mapper/vda2_crypt /root               btrfs   defaults,noatime,compress=zstd,commit=120,subvol=@root 0       0\n/dev/mapper/vda2_crypt /srv               btrfs   defaults,noatime,compress=zstd,commit=120,subvol=@srv 0       0\n/dev/mapper/vda2_crypt /var/cache               btrfs   defaults,noatime,compress=zstd,commit=120,subvol=@var_cache 0       0\n/dev/mapper/vda2_crypt /var/lib/containers               btrfs   defaults,noatime,compress=zstd,commit=120,subvol=@var_containers 0       0\n/dev/mapper/vda2_crypt /var/lib/libvirt/images               btrfs   defaults,noatime,nodatacow,commit=120,subvol=@var_libvirt 0       0\n/dev/mapper/vda2_crypt /var/logs               btrfs   defaults,noatime,compress=zstd,commit=120,subvol=@var_logs 0       0\n/dev/mapper/vda2_crypt /var/tmp               btrfs   defaults,noatime,compress=zstd,commit=120,subvol=@var_tmp 0       0\n"})}),"\n",(0,t.jsxs)(n.ol,{start:"13",children:["\n",(0,t.jsxs)(n.li,{children:["Remove old BTRFS ",(0,t.jsx)(n.code,{children:"@rootfs"})," (Debian default root volume) subvolume."]}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"btrfs sub del /mnt/@rootfs\numount /mnt\n"})}),"\n",(0,t.jsxs)(n.ol,{start:"14",children:["\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["Continue installation: ",(0,t.jsx)(n.code,{children:"ctrl+alt+f1"}),"."]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Install base system"}),"\n",(0,t.jsx)(n.li,{children:"Configure package manager"}),"\n",(0,t.jsx)(n.li,{children:"Select and install software - standard system utilities only"}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["Install the GRUB boot loader: when grub-install fails go back to the console with ",(0,t.jsx)(n.code,{children:"ctrl+alt+f3"}),"."]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"Edit the default grub config to allow for crypt volumes."}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'echo "GRUB_ENABLE_CRYPTODISK=y" >>/target/etc/default/grub\n'})}),"\n",(0,t.jsxs)(n.ol,{start:"17",children:["\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["Go back the install console: ",(0,t.jsx)(n.code,{children:"ctrl+alt+f1"}),"."]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["Run ",(0,t.jsx)(n.code,{children:"Install the GRUB boot loader"})," again, it should finish successfully this time."]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"Finish the installation and then reboot."}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"create-key-to-keep-from-being-asked-for-two-passwords",children:"Create key to keep from being asked for two passwords"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsx)(n.li,{children:"Generate the root partition encryption key."}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'mkdir -m0700 /etc/keys\n( umask 0077 && dd if=/dev/urandom bs=1 count=64 of=/etc/keys/root.key conv=excl,fsync )\ncryptsetup luksAddKey /dev/vda2 /etc/keys/root.key\ncryptsetup luksDump /dev/vda2 | grep "^Keyslots" -A16\n'})}),"\n",(0,t.jsx)(n.p,{children:"Output:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"Keyslots:\n  0: luks2\n...\nKeyslots:\n  1: luks2\n"})}),"\n",(0,t.jsxs)(n.ol,{start:"2",children:["\n",(0,t.jsxs)(n.li,{children:["Modify ",(0,t.jsx)(n.code,{children:"crypttab"})," with new key for the root device entry."]}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"cat /etc/crypttab\nvda2_crypt UUID=\u2026 /etc/keys/root.key luks,discard,x-initrd.attach,key-slot=1\n"})}),"\n",(0,t.jsxs)(n.ol,{start:"3",children:["\n",(0,t.jsxs)(n.li,{children:["Add a glob to look for keys automatically in the ",(0,t.jsx)(n.code,{children:"cryptsetup-initramfs"})," hook."]}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'echo "KEYFILE_PATTERN=\\"/etc/keys/*.key\\"" >>/etc/cryptsetup-initramfs/conf-hook\n'})}),"\n",(0,t.jsxs)(n.ol,{start:"4",children:["\n",(0,t.jsxs)(n.li,{children:["Set the ",(0,t.jsx)(n.code,{children:"UMASK"})," to prevent key leakage."]}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"echo UMASK=0077 >>/etc/initramfs-tools/initramfs.conf\n"})}),"\n",(0,t.jsxs)(n.ol,{start:"5",children:["\n",(0,t.jsx)(n.li,{children:"Regenerate the initramfs image."}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"update-initramfs -u -k all\n"})}),"\n",(0,t.jsxs)(n.ol,{start:"6",children:["\n",(0,t.jsx)(n.li,{children:"Make sure the permissions are restrictive on the initramfs."}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'stat -L -c "%A  %n" /initrd.img\n-rw-------  /initrd.img\n'})}),"\n",(0,t.jsxs)(n.ol,{start:"7",children:["\n",(0,t.jsx)(n.li,{children:"Verify the key file has been imported into the initrd image."}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'lsinitramfs /initrd.img | grep "^cryptroot/keyfiles/"\ncryptroot/keyfiles/vda2_crypt.key\n'})}),"\n",(0,t.jsxs)(n.ol,{start:"8",children:["\n",(0,t.jsx)(n.li,{children:"Reboot and you should only be presented with the initial password on boot then you will hit the grub boot menu."}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"sudo reboot\n"})}),"\n",(0,t.jsx)(n.h2,{id:"configure-snapper-and-grub-btrfs",children:"Configure snapper and grub-btrfs"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsx)(n.li,{children:"Install snapper."}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"sudo apt install snapper inotify-tools build-essential git wget curl\n"})}),"\n",(0,t.jsxs)(n.ol,{start:"2",children:["\n",(0,t.jsxs)(n.li,{children:["On installation, ",(0,t.jsx)(n.code,{children:"snapper"})," created a new BTRFS subvolume (",(0,t.jsx)(n.code,{children:"/.snapshots"}),") during the install, but we want to use ours since we're using a flat BTRSFS subvolume layout. So let's remove the one it created and use ours again."]}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"cd /\nsudo umount .snapshots\nsudo rm -r .snapshots\n"})}),"\n",(0,t.jsxs)(n.ol,{start:"3",children:["\n",(0,t.jsxs)(n.li,{children:["Create a new snapper config for the ",(0,t.jsx)(n.code,{children:"@"})," subvolume."]}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"sudo snapper -c root create-config /\n"})}),"\n",(0,t.jsxs)(n.ol,{start:"4",children:["\n",(0,t.jsx)(n.li,{children:"Delete the snapper created subvolume."}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"sudo btrfs subvolume delete /.snapshots\n"})}),"\n",(0,t.jsxs)(n.ol,{start:"5",children:["\n",(0,t.jsxs)(n.li,{children:["Use our ",(0,t.jsx)(n.code,{children:"@snapshots"})," subvolume."]}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"sudo mkdir /.snapshots\nsudo mount -av\n"})}),"\n",(0,t.jsxs)(n.ol,{start:"6",children:["\n",(0,t.jsx)(n.li,{children:"Disable the snapper boot time snapshots (unless you want them)."}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"sudo systemctl disable snapper-boot.timer\n"})}),"\n",(0,t.jsxs)(n.ol,{start:"7",children:["\n",(0,t.jsx)(n.li,{children:"Set the following snapper configs."}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"sudo nano /etc/snapper/configs/root\n"})}),"\n",(0,t.jsxs)(n.p,{children:["Recommended configuration for ",(0,t.jsx)(n.code,{children:"root"}),", but can be tweaked to your liking."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:'SUBVOLUME="/"\nFSTYPE="btrfs"\nALLOW_GROUPS="sudo"\nSYNC_ACL="yes"\nBACKGROUND_COMPARISON="yes"\nNUMBER_CLEANUP=yes"\nNUMBER_MIN_AGE"1800"\nNUMBER_LIMIT="20"\nNUMBER_LIMIT_IMPORTANT="10"\nTIMELINE_CREATE="no"\nTIMELINE_CLEANUP="yes"\nTIMELINE_MIN_AGE="1800"\nTIMELINE_LIMIT_HOURLY="5"\nTIMELINE_LIMIT_DAILY="7"\nTIMELINE_LIMIT_WEEKLY="0"\nTIMELINE_LIMIT_YEARLY="0"\nEMPTY_PRE_POST_CLEANUP="yes"\nEMPTY_PRE_POST_MIN_AGE="1800"\n'})}),"\n",(0,t.jsxs)(n.ol,{start:"8",children:["\n",(0,t.jsx)(n.li,{children:"Install grub-btrfs."}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"cd ~\nmkdir git\ncd git\ngit clone https://github.com/Antynea/grub-btrfs.git\ncd grub-btrfs\nsudo make install\n"})}),"\n",(0,t.jsxs)(n.ol,{start:"9",children:["\n",(0,t.jsx)(n.li,{children:"Enable and start service."}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"sudo systemctl enable grub-btrfsd\nsudo systemctl start grub-btrfsd\n"})}),"\n",(0,t.jsx)(n.h2,{id:"more-useful-snapshot-descriptions",children:"More useful snapshot descriptions"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsx)(n.li,{children:"Backup existing snapper apt config."}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"cp /etc/apt/apt.conf.d/80snapper /etc/apt/apt.conf.d/80snapper~\n"})}),"\n",(0,t.jsxs)(n.ol,{start:"2",children:["\n",(0,t.jsx)(n.li,{children:"Clone scripts."}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"cd ~/git\ngit clone https://gist.github.com/f722f6d08dfb404fed2a3b2d83263118.git dpkg-pre-post-snapper\ncd dpkg-pre-post-snapper\n"})}),"\n",(0,t.jsxs)(n.ol,{start:"3",children:["\n",(0,t.jsx)(n.li,{children:"Install scripts."}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"chmod +x dpkg-pre-post-snapper.sh\nsudo cp dpkg-pre-post-snapper.sh /usr/local/sbin/dpkg-pre-post-snapper\nsudo cp 80snapper /etc/apt/apt.conf.d/\n"})}),"\n",(0,t.jsxs)(n.ol,{start:"4",children:["\n",(0,t.jsxs)(n.li,{children:["Edit dpkg-pre-post-snapper location and modify the ",(0,t.jsx)(n.code,{children:"/path/to/"})," to ",(0,t.jsx)(n.code,{children:"/usr/local/sbin/"}),"."]}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"sudo nano /etc/apt/apt.conf.d/80snapper\n"})}),"\n",(0,t.jsx)(n.p,{children:"Modify the script to look like below."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'# https://gist.github.com/imthenachoman/f722f6d08dfb404fed2a3b2d83263118\n# https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=770938\n\nDPkg::Pre-Invoke { "/usr/local/sbin/dpkg-pre-post-snapper pre"; };\nDPkg::Post-Invoke { "/usr/local/sbin/dpkg-pre-post-snapper post"; };\n'})}),"\n",(0,t.jsxs)(n.ol,{start:"5",children:["\n",(0,t.jsx)(n.li,{children:"Create a baseline snapshot."}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'sudo snapper -c root create -d "base-install" -u important=yes\n'})}),"\n",(0,t.jsx)(n.admonition,{type:"tip",children:(0,t.jsx)(n.p,{children:"Keep this snapshot around as you can use it to rollback to the base installation at anytime."})}),"\n",(0,t.jsx)(n.p,{children:"Old output:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"  # | Type   | Pre # | Date | User | Cleanup | Description  | Userdata\n----+--------+-------+------+------+---------+--------------+---------------\n 0  | single |       | ...  | root |         | current      |\n 1  | single |       | ...  | root |         | base-install | important=yes\n 2  | pre    |       | ...  | root | number  | apt          |\n 3  | post   |     2 | ...  | root | number  | apt          |\n"})}),"\n",(0,t.jsxs)(n.p,{children:["New improved output with more info in the ",(0,t.jsx)(n.code,{children:"Description"})," table:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"  # | Type   | Pre # | Date | User | Cleanup | Description                | Userdata\n----+--------+-------+------+------+---------+----------------------------+---------------\n 0  | single |       | ...  | root |         | current                    |\n 1  | single |       | ...  | root |         | base-install               | important=yes\n 2  | pre    |       | ...  | root | number  | apt install btrfs-compsize |\n 3  | post   |     2 | ...  | root | number  | apt install btrfs-compsize |\n"})}),"\n",(0,t.jsx)(n.p,{children:"This will help greatly to have an idea of what changes happened in our last snapshots."}),"\n",(0,t.jsx)(n.h2,{id:"install-snapper-rollback-for-easy-snapper-rollbacks",children:"Install snapper-rollback for easy snapper rollbacks"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsx)(n.li,{children:"Downlad and install scripts and dependencies."}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"cd ~/git\ngit clone https://github.com/jrabinow/snapper-rollback.git\ncd snapper-rollback\nsudo cp snapper-rollback.py /usr/local/sbin/snapper-rollback\nsudo cp snapper-rollback.conf /etc/\nsudo apt install python3-btrfsutil\n"})}),"\n",(0,t.jsxs)(n.ol,{start:"2",children:["\n",(0,t.jsx)(n.li,{children:"Edit snapper-rollback.conf."}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"sudo nano /etc/snapper-rollback.conf\n"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"subvol_main = @\nsubvol_snapshots = @snapshots\nmountpoint = /tmp/snapper-rollback-mnt\ndev = /dev/mapper/vda2_crypt\n"})}),"\n",(0,t.jsxs)(n.ol,{start:"3",children:["\n",(0,t.jsxs)(n.li,{children:["Example rollback as seen ",(0,t.jsx)(n.a,{href:"https://github.com/jrabinow/snapper-rollback?tab=readme-ov-file#example-usage",children:"here"}),"."]}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"sudo snapper list\n # | Type   | Pre # | Date                            | User | Cleanup  | Description  | Userdata\n ---+--------+-------+---------------------------------+------+----------+--------------+---------------------\n 0  | single |       |                                 | root |          | current      |\n 1  | single |       | Mon 19 Jul 2021 08:59:01 PM PDT | root |          | base-install |\n 2  | single |       | Fri 30 Jul 2021 10:00:08 PM PDT | root | timeline | timeline     |\n 3  | single |       | Fri 30 Jul 2021 11:00:08 PM PDT | root | timeline | timeline     |\n"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"sudo snapper-rollback 1        # let's revert back to the snapshot whos description is `base-install`\nAre you SURE you want to rollback? Type 'CONFIRM' to continue: CONFIRM\n2021-10-17 23:25:47,889 - INFO - Rollback to /@snapshots/1/snapshot complete. Reboot to finish\n"})}),"\n",(0,t.jsx)(n.h2,{id:"notes",children:"Notes"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"This article is geared to towards Debian and its installer."}),"\n",(0,t.jsx)(n.li,{children:"Once Grub2 gets luks2 support with argon2 the kbkdf can get upgraded to argon2 again."}),"\n",(0,t.jsx)(n.li,{children:"I would much rather use the limine bootloader with snapper and limine-snapper-sync, but alas, I haven't gotten that configuration working as of yet in Debian... Maybe in a future article..."}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"references",children:"References"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://www.matuck.com/tech/2023/09/03/Debian-12-with-LUKS,-BTRFS,-and-subvolumes.html",children:"Debian 12 with LUKS, BTRFS, and subvolumes"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://medium.com/@inatagan/installing-debian-with-btrfs-snapper-backups-and-grub-btrfs-27212644175f",children:"Installing Debian with BTRFS, snapper, and grub-btrfs"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://gist.github.com/imthenachoman/f722f6d08dfb404fed2a3b2d83263118",children:"Better snapshot descriptions"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://cryptsetup-team.pages.debian.net/cryptsetup/encrypted-boot.html",children:"Full disk encryption, including /boot: Unlocking LUKS devices from GRUB"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://wiki.cachyos.org/installation/filesystem/#subvolume-layout",children:"CachyOS Wiki - Filesystem - BTRFS - Subvolume Layout"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://wiki.archlinux.org/title/Dm-crypt/Device_encryption#Conversion_from_LUKS1_to_LUKS2_and_back",children:"Conversion from LUKS1 to LUKS2 and back"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://www.jwillikers.com/btrfs-layout",children:"JWillikers BTRFS Layout"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://en.opensuse.org/SDB:BTRFS#Default_Subvolumes",children:"openSUSE Default Subvolumes"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://github.com/jrabinow/snapper-rollback",children:"snapper-rollback Github"})}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(d,{...e})}):d(e)}},8453(e,n,s){s.d(n,{R:()=>l,x:()=>i});var r=s(6540);const t={},a=r.createContext(t);function l(e){const n=r.useContext(a);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function i(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:l(e.components),r.createElement(a.Provider,{value:n},e.children)}}}]);